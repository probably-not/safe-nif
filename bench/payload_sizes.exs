# SafeNIF Benchmark: Payload Size Impact
#
# Tests how different payload sizes affect overhead for each approach.
# Important for understanding when SafeNIF is appropriate.
#
# Run with:
#   elixir --sname bench -S mix run bench/payload_sizes.exs
#   Generated by Claude and reviewed by @probably-not

alias SafeNIF.Bench.Helpers
alias SafeNIF.Bench.PortWrapper
alias SafeNIFTest.TestNIF

IO.puts("""
================================================================================
SafeNIF Benchmark: Payload Size Impact
================================================================================

Tests how data size affects overhead for NIF vs CLI Port vs SafeNIF.
All three use the same echo operation for fair comparison.

""")

case Helpers.setup() do
  {:ok, _ctx} ->
    IO.puts("✓ Setup complete\n")

    # Test payloads
    payloads = %{
      "tiny (10 B)" => :crypto.strong_rand_bytes(10),
      "small (100 B)" => :crypto.strong_rand_bytes(100),
      "medium (1 KB)" => :crypto.strong_rand_bytes(1_000),
      "large (10 KB)" => :crypto.strong_rand_bytes(10_000),
      "xlarge (100 KB)" => :crypto.strong_rand_bytes(100_000)
    }

    # Verify all implementations work with all payload sizes
    IO.puts("Verifying echo implementations...")

    for {name, data} <- payloads do
      ^data = TestNIF.safe_echo(data)
      ^data = PortWrapper.echo(data)
      {:ok, ^data} = SafeNIF.wrap({TestNIF, :safe_echo, [data]})
      IO.puts("  ✓ #{name}")
    end

    IO.puts("")

    # Benchmark each payload size
    for {size_name, data} <- payloads do
      IO.puts("Benchmarking #{size_name}...\n")

      safe_filename =
        size_name
        |> String.downcase()
        |> String.replace(~r/[^a-z0-9]/, "_")
        |> String.replace(~r/_+/, "_")
        |> String.trim("_")

      Benchee.run(
        %{
          "Direct NIF" => fn -> TestNIF.safe_echo(data) end,
          "CLI Port" => fn -> PortWrapper.echo(data) end,
          "SafeNIF" => fn -> SafeNIF.wrap({TestNIF, :safe_echo, [data]}) end
        },
        Helpers.benchee_config(markdown_file: "bench/results/payload_#{safe_filename}.md")
      )

      IO.puts("\n" <> String.duplicate("-", 80) <> "\n")
    end

    IO.puts("""

    ================================================================================
    Payload size benchmark complete!

    Results saved to bench/results/payload_*.md

    Key insights:
      • Direct NIF is constant time (just returns the term)
      • CLI Port overhead scales with payload (data through stdio + process spawn)
      • SafeNIF overhead is dominated by node startup, payload is minor factor
    ================================================================================
    """)

  {:error, :not_distributed} ->
    IO.puts("""
    ❌ Node is not running in distributed mode.

    Run benchmarks with:
      elixir --sname bench -S mix run bench/payload_sizes.exs
    """)

    System.halt(1)

  {:error, reason} ->
    IO.puts("❌ Setup failed: #{inspect(reason)}")
    System.halt(1)
end
