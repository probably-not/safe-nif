defmodule SafeNIF.Bench.Helpers do
  @moduledoc """
  Shared helpers for SafeNIF benchmarks.

  Generated by Claude and reviewed by @probably-not
  """

  alias SafeNIF.Bench.PortWrapper
  alias SafeNIFTest.TestNIF

  @doc """
  Ensures all benchmark dependencies are ready.
  Returns {:ok, context} or {:error, reason}.
  """
  def setup do
    with :ok <- ensure_distributed(),
         :ok <- ensure_nif_loaded(),
         :ok <- ensure_port_exists() do
      {:ok, %{}}
    end
  end

  @doc """
  Cleans up benchmark resources.
  """
  def teardown(_ctx), do: :ok

  defp ensure_distributed do
    if Node.alive?() do
      :ok
    else
      {:error, :not_distributed}
    end
  end

  defp ensure_nif_loaded do
    case TestNIF.load_nif() do
      :ok -> :ok
      {:error, reason} -> {:error, {:nif_not_loaded, reason}}
    end
  end

  defp ensure_port_exists do
    if File.exists?(PortWrapper.port_path()) do
      :ok
    else
      {:error, {:port_not_found, PortWrapper.port_path()}}
    end
  end

  @doc """
  Standard Benchee configuration.
  """
  def benchee_config(opts \\ []) do
    markdown_file = Keyword.get(opts, :markdown_file, "bench/results/latest.md")

    [
      warmup: 2,
      time: 10,
      memory_time: 2,
      reduction_time: 2,
      formatters: [
        Benchee.Formatters.Console,
        {Benchee.Formatters.Markdown, file: markdown_file}
      ]
    ]
  end
end
