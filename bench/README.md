# SafeNIF Benchmarks

Most of the code in this directory was generated by Claude and reviewed by @probably-not.

This directory contains benchmarks comparing SafeNIF's performance characteristics.

## Running Benchmarks

Ensure dependencies are installed and NIF/Port are compiled:

```bash
mix deps.get
mix compile
```

Then run individual benchmarks (must use `--sname` for distribution):

```bash
# Main comparison: NIF vs SafeNIF vs Port
elixir --sname bench -S mix run bench/nif_vs_port.exs

# Payload size impact
elixir --sname bench -S mix run bench/payload_sizes.exs
```

## Benchmark Files

| File                | Description                                       |
| ------------------- | ------------------------------------------------- |
| `nif_vs_port.exs`   | Compares Direct NIF, SafeNIF, and Port approaches |
| `payload_sizes.exs` | Tests how data size affects overhead              |

## Support Modules

| File              | Description                                     |
| ----------------- | ----------------------------------------------- |
| `helpers.ex`      | Shared setup/teardown and Benchee configuration |
| `port_wrapper.ex` | GenServer wrapping the Port executable          |

## Results

Results are saved to `bench/results/` as Markdown files. These are gitignored
by default, but you may want to commit significant baseline results.

## Understanding the Results

### Direct NIF (Unsafe)
- **Fastest** - No isolation overhead
- **Dangerous** - Crashes take down the entire node
- Use as baseline for "best possible" performance

### Port
- **Traditional safe approach** - Isolation via OS process
- **Overhead**: Process spawn + stdio + serialization
- Good for: Stateless operations, moderate throughput needs

### SafeNIF
- **Peer node isolation** - Each call runs on a `:peer` BEAM node
- **Overhead**: Distribution and cold starts, pooling is lazy
- Good for: Untrusted code, crashy NIFs, safety > speed

### When to Use What

| Approach   | Use When                                                       |
| ---------- | -------------------------------------------------------------- |
| Direct NIF | Trusted code, high performance needed, node crashes acceptable |
| Port       | Moderate isolation needs, stateless ops                        |
| SafeNIF    | Untrusted code, must not crash main node                       |
