# SafeNIF Benchmark: NIF vs SafeNIF vs CLI Port
#
# Compares three approaches to running native code:
#   1. Direct NIF call - fastest, but crashes take down the node
#   2. SafeNIF wrapped - isolated via peer nodes (new BEAM per call)
#   3. CLI Port - isolated via OS process (new process per call)
#
# Run with:
#   elixir --sname bench -S mix run bench/nif_vs_port.exs
#   Generated by Claude and reviewed by @probably-not

alias SafeNIF.Bench.Helpers
alias SafeNIF.Bench.PortWrapper
alias SafeNIFTest.TestNIF

IO.puts("""
================================================================================
SafeNIF Benchmark: NIF vs SafeNIF vs CLI Port
================================================================================

This benchmark compares execution overhead for three isolation strategies:

  • Direct NIF:  No isolation - crashes kill the node
  • CLI Port:    OS process isolation - spawns new process per call
  • SafeNIF:     Peer node isolation - spawns new BEAM nodes in a pool and each call is run on a separate BEAM node

Both CLI Port and SafeNIF provide true isolation (fresh process per call).

""")

# Setup
case Helpers.setup() do
  {:ok, _ctx} ->
    IO.puts("✓ Setup complete\n")

    # Verify everything works before benchmarking
    IO.puts("Verifying implementations...")
    :ok = TestNIF.safe_noop()
    :ok = PortWrapper.noop()
    {:ok, :ok} = SafeNIF.wrap({TestNIF, :safe_noop, []})

    42 = TestNIF.safe_add(17, 25)
    42 = PortWrapper.add(17, 25)
    {:ok, 42} = SafeNIF.wrap({TestNIF, :safe_add, [17, 25]})

    IO.puts("✓ All implementations working\n")

    # Run benchmarks
    IO.puts("Running benchmarks...\n")

    Benchee.run(
      %{
        "Direct NIF (unsafe)" => fn -> TestNIF.safe_noop() end,
        "CLI Port" => fn -> PortWrapper.noop() end,
        "SafeNIF" => fn -> SafeNIF.wrap({TestNIF, :safe_noop, []}) end
      },
      Helpers.benchee_config(markdown_file: "bench/results/noop_comparison.md")
    )

    IO.puts("\n" <> String.duplicate("=", 80) <> "\n")

    Benchee.run(
      %{
        "Direct NIF (unsafe)" => fn -> TestNIF.safe_add(17, 25) end,
        "CLI Port" => fn -> PortWrapper.add(17, 25) end,
        "SafeNIF" => fn -> SafeNIF.wrap({TestNIF, :safe_add, [17, 25]}) end
      },
      Helpers.benchee_config(markdown_file: "bench/results/add_comparison.md")
    )

    IO.puts("""

    ================================================================================
    Benchmark complete!

    Results saved to:
      • bench/results/noop_comparison.md
      • bench/results/add_comparison.md

    Note: SafeNIF is designed for SAFETY, not speed. Use it when you need
    BEAM-level isolation (crash protection, code loading, distribution).
    ================================================================================
    """)

  {:error, :not_distributed} ->
    IO.puts("""
    ❌ Node is not running in distributed mode.

    Run benchmarks with:
      elixir --sname bench -S mix run bench/nif_vs_port.exs
    """)

    System.halt(1)

  {:error, reason} ->
    IO.puts("❌ Setup failed: #{inspect(reason)}")
    IO.puts("\nMake sure to run 'mix compile' first to build the NIF and Port.")
    System.halt(1)
end
